<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="userInfoMapper">

	<!-- 일반 resultMap -->
	<resultMap type="memberDTO" id="memberDto">
		<id column="member_email" property="email" />
		<result column="member_pwd" property="pwd" />
		<result column="member_name" property="name" />
		<result column="member_phone" property="phone" />
		<result column="donation_org_no" property="donationOrgNo" />
		<result column="member_recommand" property="recommand" />
	</resultMap>
	
	<resultMap type="memberDto" id="memberDtoJoin">
		<id column="member_email" property="email" />
		<result column="member_mileage" property="mileage" />

		<collection ofType="purchaseDto" property="purchaseDto">
			<id column="purchase_no" property="no" />
			<result column="purchase_date" property="date" />
			<result column="purchase_price" property="price" />

			<collection property="purchaseProductDto" javaType="purchaseProductDto">
				<id column="purchase_no" property="purchaseNo" />
				<result column="purchase_product_no" property="productNum" />

				<association javaType="productDto" property="productDto">
					<id column="product_no" property="no" />
					<result column="product_name" property="name" />

					<association javaType="producerDto" property="producerDto">
						<id column="producer_no" property="no" />
						<result column="producer_name" property="name" />
					</association>
				</association>
			</collection>
		</collection>
	</resultMap>
	
	<!-- 조회 resultMap + 기부 resultMap-->
	<resultMap type="memberDto" id="listSearchMap">
		<id column="member_email" property="email" />

		<association property="donationOrgDto" javaType="donationOrgDto">
			<id column="donation_org_no" property="no"/>
			
			<collection property="donationDto" ofType="donationDto">
				<id column="donation_date" property="date"/>
				<result column="donation_org_no" property="donationOrgNo"/>
				<result column="donation_price" property="price"/>
			</collection>
			
		</association>
		
		<collection property="purchaseDto" ofType="purchaseDto">
			<id column="purchase_no" property="no" />
			<result column="purchase_price" property="price" />
			<result column="purchase_date" property="date" />

			<association property="purchaseStateDto" javaType="purchaseStateDto">
				<id column="purchase_state_no" property="no" />
				<result column="purchase_state_name" property="name" />
			</association>

			<collection property="purchaseProductDto" ofType="purchaseProductDto">
				<id column="purchase_no" property="purchaseNo" />
				<result column="product_no" property="productNo" />
				<result column="purchase_product_num" property="productNum" />

				<association property="productDto" javaType="productDto">
					<id column="product_no" property="no" />
					<result column="product_name" property="name" />
					<result column="producer_no" property="producerNo" />

					<association property="producerDto" javaType="producerDto">
						<id column="producer_no" property="no" />
						<result column="producer_name" property="name" />
					</association>
				</association>
			</collection>
		</collection>
	</resultMap>
	
	
	<!-- 나의 질문목록  -->
	<resultMap type="qnaDto" id="getMyPageQnaList">
		<id column="qna_no" property="no"/>
		<result column="qna_name" property="name"/>
		<result column="qna_desc" property="desc"/>
		<result column="qna_register_date" property="registerdate"/>
		<result column="member_email" property="email"/>
	</resultMap>

	<!-- 회원가입 기부업체 번호는 어떻게 처리하지? 우선은 1로 직접입력 처리 -->
	<insert id="registerMember" parameterType="memberDTO">
		insert into member values(#{email},#{pwd},#{name},#{phone},sysdate,1,0,#{recommand})
	</insert>

	<!-- 계정찾기(id) / 중복확인 -->
	<select id="searchId" parameterType="String" resultMap="memberDto">
		select member_email from member where member_name=#{name} and member_phone=#{phone}
	</select>

	<!-- 계정찾기(pwd-sendcode) -->
	<select id="searchPwdSendCode" parameterType="String" resultMap="memberDto">
		select member_email from member where member_email=#{email}
	</select>

	<!-- 계정찾기(pwd) -->
	<select id="searchPwd" parameterType="String" resultType="String">
		select member_pwd from member where member_email=#{email}
	</select>

	<!-- 로그인 -->
	<select id="login" parameterType="memberDto" resultMap="memberDto">
		select member_email,member_pwd from member
		where member_email=#{email} and member_pwd=#{pwd}
	</select>

	<!-- id 중복확인 / 추천인 id 중복확인 -->
	<select id="checkId" parameterType="String" resultMap="memberDto">
		select member_email from member where member_email=#{mail}
	</select>

	<!-- 내정보(MyPage) -->
	
	<!-- 마일리지 / 진행중인 주문내역 가져오기 -->
	<select id="getMileageAndOrderlist" resultMap="memberDtoJoin">
		select m.member_mileage,pc.purchase_date,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name
		from member m, purchase pc, product pdt, purchase_product pp, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pp.product_no=pdt.product_no and
			pdt.producer_no=pdc.producer_no and m.member_email=#{email}
	</select>


	<!-- 주문/배송 조회  -->

	<!-- 3개월 -->
	<select id="getMypageOrderList3" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_no,pc.purchase_date,pdt.product_name,pdt.product_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from purchase pc , product pdt, producer pdc, purchase_product pp, purchase_state ps
		where pc.purchase_no=pp.purchase_no and pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and
		pc.purchase_state_no=ps.purchase_state_no and member_email=#{email} and pc.purchase_date between (select sysdate -90 m_day from dual) and sysdate
	</select>

	<!-- 6개월 -->
	<select id="getMypageOrderList6" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_no,pc.purchase_date,pdt.product_name,pdt.product_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from purchase pc , product pdt, producer pdc, purchase_product pp, purchase_state ps
		where pc.purchase_no=pp.purchase_no and pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and
		pc.purchase_state_no=ps.purchase_state_no and member_email=#{email} and pc.purchase_date between (select sysdate -180 m_day from dual) and sysdate
	</select>
		
	<!-- 1년 -->
	<select id="getMypageOrderList12" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_no,pc.purchase_date,pdt.product_name,pdt.product_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from purchase pc , product pdt, producer pdc, purchase_product pp, purchase_state ps
		where pc.purchase_no=pp.purchase_no and pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and
		pc.purchase_state_no=ps.purchase_state_no and member_email=#{email} and pc.purchase_date between (select sysdate -365 m_day from dual) and sysdate
	</select>

	<!-- 전체 -->
	<select id="getMypageOrderListAll" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_no,pc.purchase_date,pdt.product_name,pdt.product_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from purchase pc , product pdt, producer pdc, purchase_product pp, purchase_state ps
		where pc.purchase_no=pp.purchase_no and pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and
		pc.purchase_state_no=ps.purchase_state_no and member_email=#{email} 
	</select>
	
	
	<!-- 취소/반품/교환 내역 조회 -->

	<!-- 3개월 -->
	<select id="getMyPageCancerList3" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
			pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.purchase_state_no>3 and
			pc.purchase_date between (select sysdate -90 m_day from dual) and sysdate
	</select>
	
	<!-- 6개월 -->
	<select id="getMyPageCancerList6" resultMap="listSearchMap"	parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
		pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.purchase_state_no>3 and
		pc.purchase_date between (select sysdate -180 m_day from dual) and sysdate
	</select>
	
	<!-- 1년 -->
	<select id="getMyPageCancerList12" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
			pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.purchase_state_no>3 and
			pc.purchase_date between (select sysdate -365 m_day from dual) and sysdate
	</select>
	
	<!-- 전체 -->
	<select id="getMyPageCancerListAll" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name,ps.purchase_state_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and
			pc.purchase_state_no=ps.purchase_state_no and pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and
			m.member_email=#{email} and ps.purchase_state_no>3
	</select>

	<!-- 환불내역 -->
	
	<!-- 3개월 -->
	<select id="getMyPageRefundList3" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
		pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.PURCHASE_STATE_NO=3 and
		pc.purchase_date between (select sysdate -90 m_day from dual) and sysdate
	</select>
	
	<!-- 6개월 -->
	<select id="getMyPageRefundList6" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
		pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.PURCHASE_STATE_NO=3 and
		pc.purchase_date between (select sysdate -180 m_day from dual) and sysdate
	</select>
	
	<!-- 1년 -->
	<select id="getMyPageRefundList12" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
		pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.PURCHASE_STATE_NO=3 and
		pc.purchase_date between (select sysdate -365 m_day from dual) and sysdate
	</select>
	
	<!-- 전체 -->
	<select id="getMyPageRefundListAll" resultMap="listSearchMap" parameterType="String">
		select pc.purchase_date,pc.purchase_no,pdt.product_name,pc.purchase_price,pp.purchase_product_num,pdc.producer_name
		from member m, purchase pc , purchase_product pp, purchase_state ps, product pdt, producer pdc
		where m.member_email=pc.member_email and pc.purchase_no=pp.purchase_no and pc.purchase_state_no=ps.purchase_state_no and
		pp.product_no=pdt.product_no and pdt.producer_no=pdc.producer_no and m.member_email=#{email} and ps.PURCHASE_STATE_NO=3
	</select>

	<!-- 주문/조회 상태에서 주문완료된 상품을 삭제할 때 -->
	<delete id="deleteOrderList" parameterType="int">
		delete from purchase
		where purchase_no=#{no} and purchase_state_no=1;
	</delete>
	
	<!-- 내정보 - 나의질문내역 가져오기 -->
	<select id="getMyPageQnaList" parameterType="String" resultMap="getMyPageQnaList">
		select qna_no,qna_name,qna_desc,qna_register_date,answer_state from qna where member_email=#{email};
	</select>
	
	<!-- 내정보 - 질문내역에 해당하는 답글 가져오기 -->
	<select id="getQnaAnswer" resultType="String" parameterType="int">
		select qna_desc from qna where qna_parent=#{no};
	</select>
	
	<!-- 내정보 - donation(donation_price, donation_date, product_name) -->
	<select id="getMyPageDonationInfo" resultMap="listSearchMap">
	   select  don.donation_price,don.donation_date, pdt.product_name
	   from member m, donation don , product pdt, purchase pc, purchase_product pp, donation_org donorg
	   where m.donation_org_no=donorg.donation_org_no and donorg.donation_org_no=don.donation_org_no and 
	   		 m.member_email=pc.member_email and pc.purchase_no= pp.purchase_no and pp.product_no=pdt.product_no and m.member_email=#{mail]; 
	</select>
	
	<!-- 내정보 - donation(회원의 총 기부금액) -->
	<select id="getMyPageTotalDonationInfo" resultMap="listSearchMap" resultType="int">
	   select  sum(don.donation_price)
	   from member m, donation don , product pdt, purchase pc, purchase_product pp, donation_org donorg
	   where m.donation_org_no=donorg.donation_org_no and donorg.donation_org_no=don.donation_org_no and 
	   		 m.member_email=pc.member_email and pc.purchase_no= pp.purchase_no and pp.product_no=pdt.product_no and m.member_email=#{mail]; 
	</select>


</mapper>